<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>莞惠-广佛肇城际列车出发板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .current-time {
            font-size: 2em;
            margin-bottom: 10px;
            color: #fff;
        }        .station-name {
            font-size: 1.5em;
            color: #fff;
        }

        .station-input-container {
            margin-top: 10px;
        }

        .station-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 1.2em;
            color: #333;
            text-align: center;
            min-width: 200px;
            outline: none;
            transition: all 0.3s ease;
        }

        .station-input:focus {
            border-color: #ff8c00;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            background: white;
        }

        .station-suggestions {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
        }

        .station-suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            color: #333;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .station-suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .station-suggestion-item:last-child {
            border-bottom: none;
        }

        .departure-board {
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .board-header {
            display: grid;
            grid-template-columns: 80px 120px 110px 170px 100px 100px auto;
            gap: 10px;
            padding: 15px 10px;
            background: #0f3460;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        .train-item {
            margin-bottom: 15px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(15, 52, 96, 0.3);
            transition: all 0.3s ease;
        }

        .train-item:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateX(5px);
        }

        .train-item.next-departure {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2));
            border-left: 4px solid #ffd700;
            animation: pulse 2s infinite;
        }

        .train-row {
            display: grid;
            grid-template-columns: 80px 120px 100px 150px 80px 120px auto;
            gap: 10px;
            padding: 15px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            align-items: center;
        }

        .train-row:hover {
            background: rgba(102, 126, 234, 0.1);
        }        .train-row.next-departure {
            background: transparent;
        }

        /* 不停靠列车的样式 */
        .train-item.not-stopping {
            min-height: 60px; /* 缩小行高 */
        }

        .train-item.not-stopping .train-row {
            grid-template-columns: 80px 120px 100px 150px 80px 120px auto;
            padding: 10px; /* 减小内边距 */
            align-items: center;
        }

        .passing-display {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px; /* 缩小高度 */
            background: rgba(149, 165, 166, 0.1);
            border-radius: 5px;
            border: 1px dashed rgba(149, 165, 166, 0.3);
        }

        .not-stopping-message {
            color: #95a5a6;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            padding: 8px 15px;
        }.stations-display {
            display: flex;
            flex-direction: column;
            gap: 3px;
            min-width: 300px;
            max-width: 100%;
            overflow: hidden;
            position: relative;
        }        .stations-track {
            display: flex;
            align-items: flex-start; /* 改为顶部对齐 */
            gap: 2px;
            position: relative;
            height: 90px; /* 从100px改为90px，稍微压缩高度 */
            padding-top: 15px; /* 添加顶部内边距，为站名留出空间 */
            transition: transform 0.5s ease;
            will-change: transform;
        }

        .stations-scroll-container {
            overflow: hidden;
            width: 100%;
            position: relative;
        }        .stations-track.scrolling {
            animation: autoScroll var(--scroll-duration) linear forwards;
        }

        .stations-track.resetting {
            transition: transform 0.8s ease-in-out;
            transform: translateX(0) !important;
        }

        .stations-track.paused {
            animation-play-state: paused;
        }

        @keyframes autoScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(var(--scroll-distance)); }
        }

        .scroll-indicator {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, transparent, rgba(22, 33, 62, 0.8));
            pointer-events: none;
            z-index: 3;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .scroll-indicator.visible {
            opacity: 1;
        }

        .station-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
            position: relative;
        }        .station-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34495e;
            border: 1px solid #34495e;
            position: relative;
            z-index: 2;
            margin-top: -8px; /* 向上移动站点圆点 */
        }

        .station-dot.stop {
            background: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }

        .station-dot.current {
            background: #e74c3c;
            border-color: #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.6);
            animation: currentStation 2s infinite;
        }

        @keyframes currentStation {
            0%, 100% { box-shadow: 0 0 8px rgba(231, 76, 60, 0.6); }
            50% { box-shadow: 0 0 15px rgba(231, 76, 60, 1); }
        }        .station-name-label {
            position: absolute;
            top: 4px; /* 从12px改为4px，向上移动8px */
            padding-right: 2px;
            font-size: 14px;
            color: #95a5a6;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            white-space: nowrap;
            /* text-align: center; */
            width: 32px;
            height: 80px;
            overflow: hidden;
            line-height: 1;
        }        .station-name-label.highlight {
            color: #ffd700;
            font-weight: bold;
        }

        .station-name-label.passed {
            color: #555;
            opacity: 0.6;
        }

        .station-dot.passed {
            background: #555;
            border-color: #555;
            box-shadow: none;
        }.track-line {
            position: absolute;
            top: 12%; /* 从50%改为35%，向上移动轨道线 */
            left: 20px; /* 从第一个站点中心开始 */
            height: 2px;
            background: linear-gradient(90deg, #34495e 0%, #2c3e50 50%, #34495e 100%);
            z-index: 1;
            transform: translateY(-50%);
            /* 宽度现在通过内联样式动态设置 */
        }

        .stations-info {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        @keyframes pulse {
            0%, 100% { border-left-color: #ffd700; }
            50% { border-left-color: #ff8c00; }
        }

        .train-type {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }        .express {
            background: #e74c3c;
            color: white;
        }

        .super-express {
            background: #8e44ad;
            color: white;
            position: relative;
        }

        .super-express::before {
            content: "特";
            position: absolute;
            left: -3px;
            top: -3px;
            background: #ffd700;
            color: #8e44ad;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .regular {
            background: #3498db;
            color: white;
        }

        .time {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
        }

        .destination {
            font-weight: bold;
            color: #fff;
        }

        .platform {
            background: #34495e;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            text-align: center;
        }        .on-time { background: #27ae60; color: white; }
        .delay { background: #e74c3c; color: white; }
        .boarding { background: #f39c12; color: white; }
        .departed { background: #7f8c8d; color: white; }
        .passing { background: #95a5a6; color: white; }

        .route-map {
            background: #16213e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .route-title {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 30px;
            color: #ffd700;
        }

        .route-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .route-line {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .route-line-title {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }        .express-title {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .super-express-title {
            background: linear-gradient(135deg, #8e44ad, #6c3483);
            color: white;
            position: relative;
        }

        .super-express-title::before {
            content: "特";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ffd700;
            color: #8e44ad;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .regular-title {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .stations-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .station {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 100px;
        }

        .station-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-bottom: 8px;
            border: 2px solid #34495e;
            position: relative;
        }

        .station-circle.stop {
            background: #ffd700;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .station-circle.pass {
            background: transparent;
            border-color: #34495e;
        }

        .station-name-map {
            font-size: 12px;
            text-align: center;
            color: #bdc3c7;
            line-height: 1.2;
        }

        .route-line-track {
            height: 2px;
            background: linear-gradient(90deg, #34495e 0%, #2c3e50 50%, #34495e 100%);
            position: relative;
            margin: 8px 0;
        }

        .next-departure-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #ffd700;
            color: #1a1a2e;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }        @media (max-width: 768px) {
            .board-header, .train-row {
                grid-template-columns: 50px 80px 70px 100px 50px 70px auto;
                font-size: 11px;
            }
            
            .stations-display {
                min-width: 150px;
                max-width: 250px;
            }
            
            .station-point {
                min-width: 25px;
            }
            
            .station-name-label {
                font-size: 7px;
                width: 25px;
                height: 20px;
            }
            
            .stations-row {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .station {
                min-width: 60px;
            }
        }        @media (max-width: 480px) {
            .stations-display {
                min-width: 120px;
                max-width: 180px;
            }
            
            .station-point {
                min-width: 20px;
            }
            
            .station-name-label {
                font-size: 6px;
                width: 20px;
                height: 18px;
            }
        }

        .refresh-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4a 100%);
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #ffed4a 0%, #ffd700 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }        .data-source {
            margin-left: 10px;
            font-size: 12px;
            opacity: 0.8;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .direction-selector {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .direction-option {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 500;
        }

        .direction-option:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .direction-option.active {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            border-color: #ffd700;
            color: #333;
            font-weight: bold;
        }
    </style>
</head>
<body>    <div class="header">
        <div class="current-time" id="currentTime"></div>
        <div class="station-input-container" style="position: relative;">
            <input type="text" 
                   class="station-input" 
                   id="currentStationInput" 
                   value="肇庆站" 
                   placeholder="请输入当前站点名称"
                   autocomplete="off">
            <div class="station-suggestions" id="stationSuggestions"></div>
        </div>
        <div class="station-name">出发信息</div>        <div style="margin-top: 10px;">
            <button id="refreshDataBtn" onclick="refreshTrainData()" 
                    class="refresh-btn">
                刷新12306数据
            </button>
            <span id="dataSource" class="data-source">数据源: 模拟数据</span>
        </div>
          <div class="direction-selector">
            <div class="direction-option" onclick="switchDirection('zhaoqing')" id="directionZhaoqing">
                肇庆方向
            </div>
            <div class="direction-option active" onclick="switchDirection('huizhou')" id="directionHuizhou">
                惠州方向
            </div>
        </div>
    </div>

    <div class="departure-board">
        <div class="board-header">
            <div>车次</div>
            <div>列车号</div>
            <div>发车时间</div>
            <div>终点站</div>
            <div>站台</div>
            <div>状态</div>
            <div>停靠站点</div>
        </div>
        <div id="trainList"></div>
    </div>


    <script>        // 所有站点按顺序排列（基于真实C7514/C7515列车案例）
        const allStations = [
            "肇庆站", "端州站", "鼎湖山站", "鼎湖东站", "四会站", "大旺站", 
            "云东海站", "三水北站", "狮山北站", "狮山站", "佛山西站", "张槎站", 
            "顺德北站", "北滘西站", "陈村站", "番禺站", "广州长隆站", "东环站", 
            "官桥北站", "广州莲花山站", "麻涌站", "东莞西站", "道滘站", "西平西站", 
            "东城南站", "寮步站", "松山湖北站", "大朗镇站", "常平南站", "常平东站", 
            "樟木头东站", "银瓶站", "沥林北站", "陈江南站", "惠环站", "龙丰站", 
            "西湖东站", "云山站", "小金口站"
        ];        // 快车停靠站点（基于实际快车停靠模式）
        const expressStops = new Set([
            "肇庆站", "鼎湖东站", "大旺站", "三水北站", "佛山西站", 
            "番禺站", "广州长隆站", "广州莲花山站", "东莞西站", 
            "西平西站", "松山湖北站", "常平南站", "陈江南站", "西湖东站", 
            "云山站", "小金口站"
        ]);

        // 特快停靠站点（停靠更少站点）
        const superExpressStops = new Set([
            "肇庆站", "佛山西站", "番禺站", "西平西站", "小金口站"
        ]);        // 滚动管理器
        class ScrollManager {
            constructor() {
                this.scrollElements = new Map();
                this.globalScrollTimer = null;
                this.globalPauseTimer = null;
                this.globalResetTimer = null;
                this.isGloballyPaused = false;
                this.hasUserInteraction = false;
                this.finishedScrolls = new Set(); // 记录已完成滚动的轨道
            }            setupScrolling(trackElement, containerElement) {
                const trackId = trackElement.id;
                
                // 清除之前的状态
                this.clearTrackScrolling(trackId);
                
                // 检查是否需要滚动
                const containerWidth = containerElement.offsetWidth;
                const trackWidth = trackElement.scrollWidth;
                const scrollIndicator = containerElement.querySelector('.scroll-indicator');
                
                if (trackWidth <= containerWidth) {
                    scrollIndicator.classList.remove('visible');
                    return;
                }
                
                scrollIndicator.classList.add('visible');
                
                // 计算滚动距离和持续时间
                const scrollDistance = trackWidth - containerWidth + 80; // 额外100px确保完全显示
                const scrollSpeed = 30; // 固定速度：50像素/秒
                const scrollDuration = scrollDistance / scrollSpeed; // 根据距离和速度计算时间
                
                // 设置CSS变量
                trackElement.style.setProperty('--scroll-distance', `-${scrollDistance}px`);
                trackElement.style.setProperty('--scroll-duration', `${scrollDuration}s`);
                
                // 存储元素信息
                this.scrollElements.set(trackId, {
                    trackElement,
                    containerElement,
                    needsScroll: true,
                    duration: scrollDuration,
                    isFinished: false
                });
                
                // 添加动画结束监听
                this.addAnimationEndListener(trackElement, trackId);
                
                // 添加交互事件
                this.addInteractionEvents(trackElement, containerElement, trackId);
            }            addAnimationEndListener(trackElement, trackId) {
                const onAnimationEnd = (event) => {
                    // 确保是这个元素自己的动画结束，不是子元素的
                    if (event.target !== trackElement) return;
                    
                    console.log(`轨道 ${trackId} 滚动完成`);
                    
                    // 动画完成，标记为已完成
                    if (this.scrollElements.has(trackId)) {
                        this.scrollElements.get(trackId).isFinished = true;
                        this.finishedScrolls.add(trackId);
                        
                        // 移除滚动类，但设置最终的transform位置以保持在结尾
                        trackElement.classList.remove('scrolling');
                        const finalPosition = trackElement.style.getPropertyValue('--scroll-distance');
                        trackElement.style.transform = `translateX(${finalPosition})`;
                        
                        // 检查是否所有需要滚动的轨道都已完成
                        this.checkAllScrollsFinished();
                    }
                };
                
                trackElement.addEventListener('animationend', onAnimationEnd);
                
                // 存储事件处理器以便后续清理
                if (this.scrollElements.has(trackId)) {
                    this.scrollElements.get(trackId).animationHandler = onAnimationEnd;
                }
            }checkAllScrollsFinished() {
                const needsScrollElements = Array.from(this.scrollElements.values())
                    .filter(data => data.needsScroll);
                    
                const finishedCount = needsScrollElements.filter(data => data.isFinished).length;
                const totalCount = needsScrollElements.length;
                
                console.log(`滚动进度: ${finishedCount}/${totalCount} 轨道已完成`);
                    
                const allFinished = needsScrollElements.every(data => data.isFinished);
                
                if (allFinished && needsScrollElements.length > 0) {
                    console.log('所有轨道滚动完成，5秒后重置');
                    // 所有轨道都完成了滚动，等待一段时间后重置
                    if (this.globalResetTimer) {
                        clearTimeout(this.globalResetTimer);
                    }
                    
                    this.globalResetTimer = setTimeout(() => {
                        this.resetAllScrollsToStart();
                    }, 5000); // 等待5秒后重置，让用户有足够时间查看
                }
            }            resetAllScrollsToStart() {
                if (this.isGloballyPaused) return;
                
                console.log('重置所有滚动到起始位置');
                
                // 添加重置动画类，平滑过渡回起始位置
                this.scrollElements.forEach((data, trackId) => {
                    if (data.needsScroll) {
                        data.trackElement.classList.add('resetting');
                        data.isFinished = false;
                    }
                });
                
                // 清空已完成集合
                this.finishedScrolls.clear();
                
                // 等待重置动画完成后移除过渡类并重新开始滚动
                setTimeout(() => {
                    this.scrollElements.forEach((data, trackId) => {
                        if (data.needsScroll) {
                            data.trackElement.classList.remove('resetting');
                            // 清除之前设置的 transform，确保元素回到起始位置
                            data.trackElement.style.transform = 'translateX(0)';
                        }
                    });
                    
                    // 重新开始滚动
                    setTimeout(() => {
                        this.startGlobalScrolling();
                    }, 500); // 再等待0.5秒后开始新一轮滚动
                }, 800); // 等待重置动画完成（0.8秒）
            }startGlobalScrolling() {
                // 清除之前的全局计时器
                if (this.globalScrollTimer) {
                    clearTimeout(this.globalScrollTimer);
                }
                
                console.log('准备开始全局滚动，2秒后启动');
                
                // 延迟开始所有滚动
                this.globalScrollTimer = setTimeout(() => {
                    if (!this.isGloballyPaused) {
                        const scrollingTracks = [];
                        this.scrollElements.forEach((data, trackId) => {
                            if (data.needsScroll && !data.isFinished) {
                                data.trackElement.classList.add('scrolling');
                                scrollingTracks.push(`${trackId}(${data.duration.toFixed(1)}s)`);
                            }
                        });
                        console.log('开始滚动轨道:', scrollingTracks.join(', '));
                    }
                }, 2000);
            }

            pauseAllScrolling() {
                this.isGloballyPaused = true;
                this.hasUserInteraction = true;
                
                // 暂停所有滚动
                this.scrollElements.forEach((data) => {
                    data.trackElement.classList.add('paused');
                });
            }

            resumeAllScrolling(delay = 3000) {
                // 清除之前的恢复计时器
                if (this.globalPauseTimer) {
                    clearTimeout(this.globalPauseTimer);
                }

                // 设置延迟恢复
                this.globalPauseTimer = setTimeout(() => {
                    this.isGloballyPaused = false;
                    this.hasUserInteraction = false;
                    
                    // 恢复所有滚动
                    this.scrollElements.forEach((data) => {
                        data.trackElement.classList.remove('paused');
                    });
                }, delay);
            }            clearTrackScrolling(trackId) {
                if (this.scrollElements.has(trackId)) {
                    const data = this.scrollElements.get(trackId);
                    data.trackElement.classList.remove('scrolling', 'paused', 'resetting');
                    
                    // 移除动画监听器
                    if (data.animationHandler) {
                        data.trackElement.removeEventListener('animationend', data.animationHandler);
                    }
                    
                    this.scrollElements.delete(trackId);
                    this.finishedScrolls.delete(trackId);
                }
            }

            clearAllScrolling() {
                // 清除所有计时器
                if (this.globalScrollTimer) {
                    clearTimeout(this.globalScrollTimer);
                    this.globalScrollTimer = null;
                }
                
                if (this.globalPauseTimer) {
                    clearTimeout(this.globalPauseTimer);
                    this.globalPauseTimer = null;
                }
                
                if (this.globalResetTimer) {
                    clearTimeout(this.globalResetTimer);
                    this.globalResetTimer = null;
                }                // 清除所有滚动状态
                this.scrollElements.forEach((data, trackId) => {
                    data.trackElement.classList.remove('scrolling', 'paused', 'resetting');
                    data.trackElement.style.transform = 'translateX(0)';
                    
                    // 移除动画监听器
                    if (data.animationHandler) {
                        data.trackElement.removeEventListener('animationend', data.animationHandler);
                    }
                });
                
                this.scrollElements.clear();
                this.finishedScrolls.clear();
                this.isGloballyPaused = false;
                this.hasUserInteraction = false;
            }

            addInteractionEvents(trackElement, containerElement, trackId) {
                // 鼠标事件 - 影响全局
                containerElement.addEventListener('mouseenter', () => {
                    this.pauseAllScrolling();
                });
                
                containerElement.addEventListener('mouseleave', () => {
                    this.resumeAllScrolling();
                });
                
                // 触摸事件 - 影响全局
                let startX = 0;
                let currentX = 0;
                let isDragging = false;

                containerElement.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    currentX = startX;
                    isDragging = true;
                    this.pauseAllScrolling();
                    e.preventDefault();
                });

                containerElement.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    
                    currentX = e.touches[0].clientX;
                    const deltaX = currentX - startX;
                    
                    // 手动滚动当前元素
                    const currentTransform = trackElement.style.transform.match(/translateX\(([^)]+)\)/);
                    const currentOffset = currentTransform ? parseFloat(currentTransform[1]) : 0;
                    const newOffset = Math.min(0, Math.max(
                        parseFloat(trackElement.style.getPropertyValue('--scroll-distance')), 
                        currentOffset + deltaX
                    ));
                    
                    trackElement.style.transform = `translateX(${newOffset}px)`;
                    startX = currentX;
                    e.preventDefault();
                });

                containerElement.addEventListener('touchend', () => {
                    isDragging = false;
                    this.resumeAllScrolling(5000); // 触摸结束后5秒恢复全局滚动
                });
            }
        }

        const scrollManager = new ScrollManager();        // 当前站点变量
        let currentStation = "小金口站";
        
        // 当前方向状态：'zhaoqing' 表示肇庆方向，'huizhou' 表示惠州方向
        let currentDirection = 'huizhou';
        
        // 获取当前方向的站点列表
        function getCurrentDirectionStations() {
            if (currentDirection === 'huizhou') {
                // 惠州方向：站点顺序反转
                return [...allStations].reverse();
            } else {
                // 肇庆方向：原始顺序
                return allStations;
            }
        }
        
        // 获取当前方向的快车停靠站点
        function getCurrentDirectionExpressStops() {
            if (currentDirection === 'huizhou') {
                // 惠州方向：站点顺序反转
                const reversedStations = [...allStations].reverse();
                const reversedExpressStops = new Set();
                expressStops.forEach(station => reversedExpressStops.add(station));
                return reversedExpressStops;
            } else {
                // 肇庆方向：原始停靠站
                return expressStops;
            }
        }
        
        // 获取当前方向的特快停靠站点
        function getCurrentDirectionSuperExpressStops() {
            if (currentDirection === 'huizhou') {
                // 惠州方向：站点顺序反转
                const reversedStations = [...allStations].reverse();
                const reversedSuperExpressStops = new Set();
                superExpressStops.forEach(station => reversedSuperExpressStops.add(station));
                return reversedSuperExpressStops;
            } else {
                // 肇庆方向：原始停靠站
                return superExpressStops;
            }
        }
        
        // 切换方向功能
        function switchDirection(direction) {
            if (currentDirection === direction) return;
            
            currentDirection = direction;
            
            // 更新界面选中状态
            document.getElementById('directionZhaoqing').classList.toggle('active', direction === 'zhaoqing');
            document.getElementById('directionHuizhou').classList.toggle('active', direction === 'huizhou');
            
            // 更新当前站点为新方向的起始站
            const currentDirectionStations = getCurrentDirectionStations();
            if (direction === 'huizhou') {
                // 惠州方向：小金口站为起始站
                currentStation = "小金口站";
            } else {
                // 肇庆方向：肇庆站为起始站
                currentStation = "肇庆站";
            }
            
            // 更新站点输入框显示
            document.getElementById('currentStationInput').value = currentStation;
            
            // 重新获取列车数据并渲染
            fetchTrainData().then(() => {
                renderTrainList();
            });
            
            console.log(`切换到${direction === 'zhaoqing' ? '肇庆' : '惠州'}方向，当前站点: ${currentStation}`);
        }
        function initializeScrolling() {
            // 清除之前的所有滚动状态
            scrollManager.clearAllScrolling();

            // 为每个轨道设置滚动
            trainData.forEach((_, index) => {
                const trackElement = document.getElementById(`track-${index}`);
                const containerElement = document.getElementById(`scroll-container-${index}`);
                
                if (trackElement && containerElement) {
                    scrollManager.setupScrolling(trackElement, containerElement);
                }
            });
            
            // 启动全局同步滚动
            scrollManager.startGlobalScrolling();
        }        // 12306 API集成
        class Railway12306API {
            constructor() {
                this.stationCodes = new Map(); // 存储站点名称到代码的映射
                this.proxyBaseUrl = 'http://localhost:3001'; // 代理服务器地址
                this.loadStationCodes();
            }

            // 加载车站代码信息
            async loadStationCodes() {
                try {
                    console.log('开始加载车站代码...');
                    const response = await fetch(`${this.proxyBaseUrl}/api/station-codes`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const text = await response.text();
                      // 解析station_names字符串
                    const match = text.match(/var station_names ='(.+)';/);
                    if (match) {
                        const stationData = match[1];
                        const stations = stationData.split('@').filter(item => item.length > 0);
                        
                        stations.forEach(station => {
                            const parts = station.split('|');
                            if (parts.length >= 3) {
                                const stationName = parts[1]; // 中文名
                                const stationCode = parts[2]; // 英文代码
                                
                                // 为站名添加"站"字后缀，以匹配我们的站点名称格式
                                const stationNameWithSuffix = stationName.endsWith('站') ? stationName : stationName + '站';
                                this.stationCodes.set(stationNameWithSuffix, stationCode);
                                
                                // 同时也保存不带"站"字的映射，以防万一
                                this.stationCodes.set(stationName, stationCode);
                            }
                        });
                        
                        console.log('车站代码加载完成，共', this.stationCodes.size, '个车站');
                    } else {
                        throw new Error('无法解析车站代码数据');
                    }
                } catch (error) {
                    console.error('加载车站代码失败:', error);
                    // 使用备用的手动映射
                    this.initBackupStationCodes();
                }
            }            // 备用的车站代码映射
            initBackupStationCodes() {
                const backupCodes = {
                    '肇庆': 'ZQQ',
                    '端州': 'DZQ',
                    '鼎湖山': 'DHQ',
                    '鼎湖东': 'DRQ',
                    '四会': 'SHQ',
                    '大旺': 'DWQ',
                    '云东海': 'YDQ',
                    '三水北': 'SBQ',
                    '狮山北': 'SSH',
                    '狮山': 'SSQ',
                    '佛山西': 'FOQ',
                    '张槎': 'ZCQ',
                    '顺德北': 'SXQ',
                    '北滘西': 'BJQ',
                    '陈村': 'CEQ',
                    '番禺': 'PYQ',
                    '广州长隆': 'CLQ',
                    '东环': 'DHQ',
                    '官桥北': 'GQQ',
                    '广州莲花山': 'LHQ',
                    '麻涌': 'MCQ',
                    '东莞西': 'DMQ',
                    '道滘': 'DJQ',
                    '西平西': 'XPQ',
                    '东城南': 'DCQ',
                    '寮步': 'LBQ',
                    '松山湖北': 'SSQ',
                    '大朗镇': 'DLQ',
                    '常平南': 'CPQ',
                    '常平东': 'CPQ',
                    '樟木头东': 'ZMQ',
                    '银瓶': 'YPQ',
                    '沥林北': 'LLQ',
                    '陈江南': 'CJQ',
                    '惠环': 'HHQ',
                    '龙丰': 'LFQ',
                    '西湖东': 'XHQ',
                    '云山': 'YSQ',
                    '小金口': 'XJQ'
                };
                
                Object.entries(backupCodes).forEach(([name, code]) => {
                    // 保存不带"站"字的映射
                    this.stationCodes.set(name, code);
                    // 同时保存带"站"字的映射
                    this.stationCodes.set(name + '站', code);
                });
                
                console.log('备用车站代码初始化完成，共', this.stationCodes.size, '个车站');
            }// 获取车站代码
            getStationCode(stationName) {
                // 首先尝试直接查找
                if (this.stationCodes.has(stationName)) {
                    return this.stationCodes.get(stationName);
                }
                
                // 如果没找到，尝试添加或移除"站"字
                if (stationName.endsWith('站')) {
                    // 如果带"站"字，尝试不带"站"字的版本
                    const nameWithoutSuffix = stationName.slice(0, -1);
                    if (this.stationCodes.has(nameWithoutSuffix)) {
                        return this.stationCodes.get(nameWithoutSuffix);
                    }
                } else {
                    // 如果不带"站"字，尝试带"站"字的版本
                    const nameWithSuffix = stationName + '站';
                    if (this.stationCodes.has(nameWithSuffix)) {
                        return this.stationCodes.get(nameWithSuffix);
                    }
                }
                
                return null;
            }// 查询列车余票信息
            async queryTrains(fromStation, toStation, date) {
                const fromCode = this.getStationCode(fromStation);
                const toCode = this.getStationCode(toStation);
                
                if (!fromCode || !toCode) {
                    console.error('未找到车站代码:', { fromStation, toStation, fromCode, toCode });
                    return [];
                }
                
                try {
                    console.log(`查询列车: ${fromStation}(${fromCode}) -> ${toStation}(${toCode}) 日期: ${date}`);
                    
                    const url = `${this.proxyBaseUrl}/api/query-trains`;
                    const params = new URLSearchParams({
                        from_station: fromCode,
                        to_station: toCode,
                        train_date: date
                    });
                    
                    const response = await fetch(`${url}?${params}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                      if (data.data && data.data.result) {
                        const trains = this.parseTrainResults(data.data.result);
                        console.log(`🚆 查询到${trains.length}趟列车 (${fromStation} → ${toStation})`);
                        return trains;
                    }
                    console.warn('⚠️ 未获取到列车数据');
                    return [];
                } catch (error) {
                    console.error('查询列车信息失败:', error);
                    return [];
                }
            }

            // 解析列车查询结果
            parseTrainResults(results) {
                return results.map(result => {
                    const parts = result.split('|');
                    if (parts.length >= 35) {
                        return {
                            trainNo: parts[2], // 列车号编码
                            trainCode: parts[3], // 车次
                            fromStation: parts[4],
                            toStation: parts[5],
                            fromStationName: parts[6],
                            toStationName: parts[7],
                            startTime: parts[8],
                            arriveTime: parts[9],
                            duration: parts[10]
                        };
                    }
                    return null;
                }).filter(train => train !== null);
            }            // 查询列车详细信息
            async queryTrainDetails(trainNo, fromCode, toCode, date) {
                try {
                    console.log(`查询列车详细信息: ${trainNo}`);
                    
                    const url = `${this.proxyBaseUrl}/api/train-details`;
                    const params = new URLSearchParams({
                        train_no: trainNo,
                        from_station_telecode: fromCode,
                        to_station_telecode: toCode,
                        depart_date: date
                    });
                    
                    const response = await fetch(`${url}?${params}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();                    if (data.data && data.data.data) {
                        // 检查列车是否包含"佛山西"站点（不含空格），如果包含则说明是其他线路的列车，直接过滤掉
                        const stationNames = data.data.data.map(station => station.station_name);
                        const hasFoshanXi = stationNames.some(name => {
                            if (!name) return false;
                            // 只检查不含空格的"佛山西"，含空格的"佛山 西"不过滤
                            return name === '佛山西' || name === '佛山西站';
                        });
                        
                        if (hasFoshanXi) {
                            console.log(`🚫 列车${trainNo}包含佛山西站点，判定为其他线路列车，完全过滤掉`);
                            console.log('📍 该列车停靠站点:', stationNames.join(' → '));
                            return null; // 返回null表示该列车应被过滤掉
                        }
                        
                        console.log(`✅ 列车${trainNo}通过过滤检查，包含${data.data.data.length}个站点`);
                        return data.data.data;
                    }
                    return [];
                } catch (error) {
                    console.error('查询列车详细信息失败:', error);
                    return [];
                }            }// 判断列车类型
            determineTrainType(trainCode, stations) {
                // 根据车次号判断列车类型
                // 提取车次号中的数字部分
                const trainNumber = trainCode.replace(/[^0-9]/g, '');
                const trainNum = parseInt(trainNumber);
                
                if (trainNum >= 6880 && trainNum <= 6899) {
                    return '特快';
                } else if (trainNumber.startsWith('68')) {
                    return '快车';
                } else {
                    return '普通';
                }
            }
        }        // 初始化12306 API
        const railway12306 = new Railway12306API();

        // 根据车次号判断列车类型的通用函数
        function getTrainTypeByNumber(trainNumber) {
            if (!trainNumber) return '普通';
            
            // 提取车次号中的数字部分
            const numberOnly = trainNumber.replace(/[^0-9]/g, '');
            const trainNum = parseInt(numberOnly);
            
            if (trainNum >= 6880 && trainNum <= 6899) {
                return '特快';
            } else if (numberOnly.startsWith('68')) {
                return '快车';
            } else {
                return '普通';
            }
        }// 列车数据（现在从12306获取或使用模拟数据）
        let trainData = [
            {
                type: "快车",
                number: "C6801",
                time: (() => {
                    // 生成一个已发车的时间（比当前时间早5分钟）
                    const now = new Date();
                    const pastTime = new Date(now.getTime() - 5 * 60000);
                    return `${pastTime.getHours().toString().padStart(2, '0')}:${pastTime.getMinutes().toString().padStart(2, '0')}`;
                })(),
                destination: "广州长隆站",
                platform: "3",
                status: "已发车",
                note: "1-8号车厢"
            },
            {
                type: "普通",
                number: "C7501",
                time: (() => {
                    // 生成一个即将发车的时间（比当前时间晚2分钟）
                    const now = new Date();
                    const soonTime = new Date(now.getTime() + 2 * 60000);
                    return `${soonTime.getHours().toString().padStart(2, '0')}:${soonTime.getMinutes().toString().padStart(2, '0')}`;
                })(),
                destination: "小金口站",
                platform: "2",
                status: "即将发车",
                note: "1-8号车厢"
            },
            {
                type: "特快",
                number: "C6881",
                time: (() => {
                    // 生成一个正在检票的时间（比当前时间晚8分钟）
                    const now = new Date();
                    const checkTime = new Date(now.getTime() + 8 * 60000);
                    return `${checkTime.getHours().toString().padStart(2, '0')}:${checkTime.getMinutes().toString().padStart(2, '0')}`;
                })(),
                destination: "西平西站",
                platform: "1",
                status: "正在检票",
                note: "1-8号车厢"
            },
            {
                type: "快车",
                number: "C6802",
                time: "18:05",
                destination: "东莞西站",
                platform: "4",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "普通",
                number: "C7502",
                time: "18:15",
                destination: "惠环站",
                platform: "1",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "特快",
                number: "C6882",
                time: "18:20",
                destination: "小金口站",
                platform: "3",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "快车",
                number: "C6803",
                time: "18:25",
                destination: "松山湖北站",
                platform: "3",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "普通",
                number: "C7503",
                time: "18:38",
                destination: "龙丰站",
                platform: "2",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "特快",
                number: "C6883",
                time: "18:45",
                destination: "佛山西站",
                platform: "4",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "快车",
                number: "C6804",
                time: "18:50",
                destination: "常平南站",
                platform: "4",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "普通",
                number: "C7504",
                time: "19:05",
                destination: "陈江南站",
                platform: "1",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "快车",
                number: "C6805",
                time: "19:12",
                destination: "广州莲花山站",
                platform: "2",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "普通",
                number: "C7505",
                time: "19:25",
                destination: "西湖东站",
                platform: "3",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "特快",
                number: "C6884",
                time: "19:30",
                destination: "番禺站",
                platform: "1",
                status: "准点",
                note: "1-8号车厢"
            },
            {
                type: "快车",
                number: "C6806",
                time: "19:45",
                destination: "三水北站",
                platform: "4",
                status: "准点",
                note: "1-8号车厢"
            }
        ];

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            document.getElementById('currentTime').textContent = `${dateString} ${timeString}`;        }

        // 根据当前时间和发车时间计算列车状态
        function calculateTrainStatus(departureTime) {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // 解析发车时间
            const [hours, minutes] = departureTime.split(':').map(Number);
            const departMinutes = hours * 60 + minutes;
            
            // 计算时间差（分钟）
            const timeDiff = departMinutes - currentMinutes;
            
            if (timeDiff <= 0) {
                // 已经发车或正在发车
                return { status: '已发车', class: 'departed' };
            } else if (timeDiff <= 4) {
                // 4分钟内即将发车
                return { status: '即将发车', class: 'boarding' };
            } else if (timeDiff <= 15) {
                // 15分钟内开始检票
                return { status: '正在检票', class: 'boarding' };
            } else {
                // 正常状态
                return { status: '准点', class: 'on-time' };
            }
        }        function getNextDeparture() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // 查找真正"即将发车"状态的列车（4分钟内发车）
            for (let train of trainData) {
                const [hours, minutes] = train.time.split(':').map(Number);
                const trainMinutes = hours * 60 + minutes;
                const timeDiff = trainMinutes - currentMinutes;
                
                // 只有在4分钟内即将发车的列车才被标记为"即将发车"
                if (timeDiff > 0 && timeDiff <= 4) {
                    return train.number;
                }
            }
            
            // 如果没有即将发车的列车，返回null（不高亮任何列车）
            return null;
        }function renderStationsDisplay(train, index, isPassing = false) {
            // 如果是通过状态，返回简化的显示
            if (isPassing) {
                return `
                    <div class="stations-display passing-display">
                        <div class="not-stopping-message">列车不停靠本站</div>
                    </div>
                `;
            }
            
            // 获取当前方向的站点和停靠信息
            const currentDirectionStations = getCurrentDirectionStations();
            const currentDirectionExpressStops = getCurrentDirectionExpressStops();
            const currentDirectionSuperExpressStops = getCurrentDirectionSuperExpressStops();
              // 根据车次号动态判断列车类型
            const actualType = getTrainTypeByNumber(train.number);
            const isExpress = actualType === '快车';
            const isSuperExpress = actualType === '特快';
            
            // 在查找终点站索引时，去除可能存在的空格以便正确匹配
            let destinationIndex = -1;
            if (train.destination) {
                // 先尝试直接匹配
                destinationIndex = currentDirectionStations.indexOf(train.destination);
                
                // 如果直接匹配失败，尝试去除空格后匹配
                if (destinationIndex === -1) {
                    const normalizedDestination = train.destination.replace(/\s+/g, '');
                    destinationIndex = currentDirectionStations.findIndex(station => 
                        station.replace(/\s+/g, '') === normalizedDestination
                    );
                }
            }
            
            const currentStationIndex = currentDirectionStations.indexOf(currentStation);
            
            // 修改显示逻辑：从当前站开始显示到终点站
            let stationsToShow;
            if (destinationIndex === -1) {
                // 如果找不到终点站，从当前站显示所有后续站点
                stationsToShow = currentDirectionStations.slice(currentStationIndex);
            } else {
                // 从当前站显示到终点站
                stationsToShow = currentDirectionStations.slice(currentStationIndex, destinationIndex + 1);
            }
              const stationPoints = stationsToShow.map((station, stationIndex) => {
                const globalStationIndex = currentDirectionStations.indexOf(station);
                let dotClass = 'station-dot';
                let nameClass = 'station-name-label';
                  // 判断站点状态
                if (station === currentStation) {
                    dotClass += ' current';
                    nameClass += ' highlight';
                } else {
                    // 由于现在只显示从当前站开始的站点，不会有已过站的情况
                    // 根据列车类型判断是否停靠
                    if (isSuperExpress && currentDirectionSuperExpressStops.has(station)) {
                        dotClass += ' stop';
                        nameClass += ' highlight';
                    } else if (isExpress && !isSuperExpress && currentDirectionExpressStops.has(station)) {
                        dotClass += ' stop';
                        nameClass += ' highlight';
                    } else if (!isExpress && !isSuperExpress) {
                        // 普通列车停靠所有站点
                        dotClass += ' stop';
                        nameClass += ' highlight';
                    }
                }
                
                return `
                    <div class="station-point">
                        <div class="${dotClass}"></div>
                        <div class="${nameClass}">${station.replace('站', '')}</div>
                    </div>
                `;
            }).join('');            const trainTypeText = isSuperExpress ? '特快' : (isExpress ? '快车' : '普通');
            const stopsCount = isSuperExpress ? 
                stationsToShow.filter(s => currentDirectionSuperExpressStops.has(s)).length : 
                (isExpress ? 
                    stationsToShow.filter(s => currentDirectionExpressStops.has(s)).length : 
                    stationsToShow.length);
            
            const trackId = `track-${index}`;
            const scrollContainerId = `scroll-container-${index}`;            // 计算轨道线的实际宽度：站点数量 * 站点最小宽度 - 一个站点宽度（因为是从第一个站点中心开始）
            const trackLineWidth = (stationsToShow.length - 1) * 42; // 40px最小宽度 + 2px间隙
              return `
                <div class="stations-display">
                    <div class="stations-scroll-container" id="${scrollContainerId}">
                        <div class="stations-track" id="${trackId}">
                            <div class="track-line" style="width: ${trackLineWidth}px;"></div>
                            ${stationPoints}
                        </div>
                        <div class="scroll-indicator"></div>
                    </div>
                    <div class="stations-info">${trainTypeText} | ${stopsCount}站</div>
                </div>
            `;}        function renderTrainList() {
            const trainListElement = document.getElementById('trainList');
            
            trainListElement.innerHTML = trainData.map((train, index) => {
                // 根据车次号动态判断列车类型
                const actualType = getTrainTypeByNumber(train.number);
                const typeClass = actualType === '特快' ? 'super-express' : 
                                 (actualType === '快车' ? 'express' : 'regular');
                
                // 获取当前方向的停靠站信息
                const currentDirectionExpressStops = getCurrentDirectionExpressStops();
                const currentDirectionSuperExpressStops = getCurrentDirectionSuperExpressStops();
                
                // 检查当前站是否为该列车种别停靠站
                const isExpress = actualType === '快车';
                const isSuperExpress = actualType === '特快';
                let isCurrentStationStop = true;
                
                if (isSuperExpress && !currentDirectionSuperExpressStops.has(currentStation)) {
                    isCurrentStationStop = false;
                } else if (isExpress && !isSuperExpress && !currentDirectionExpressStops.has(currentStation)) {
                    isCurrentStationStop = false;
                }
                  // 根据是否停靠修改状态
                let displayStatus, statusClass;
                
                if (!isCurrentStationStop) {
                    displayStatus = '通过';
                    statusClass = 'passing';
                } else {
                    // 使用新的状态计算函数
                    const statusInfo = calculateTrainStatus(train.time);
                    displayStatus = statusInfo.status;
                    statusClass = statusInfo.class;
                }
                  const stationsDisplay = renderStationsDisplay(train, index, !isCurrentStationStop);                  return `
                    <div class="train-item ${displayStatus === '即将发车' ? 'next-departure' : ''} ${!isCurrentStationStop ? 'not-stopping' : ''}">
                        <div class="train-row">
                            <div class="train-type ${typeClass}">${actualType}</div>
                            <div style="font-weight: bold; color: #fff;">${train.number}</div>
                            <div class="time">${train.time}</div>
                            <div class="destination">${train.destination}</div>
                            <div class="platform">${train.platform}</div>
                            <div class="status ${statusClass}">${displayStatus}</div>
                            ${stationsDisplay}
                            ${displayStatus === '即将发车' ? '<div class="next-departure-indicator">即将发车</div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // 初始化同步滚动功能
            setTimeout(initializeScrolling, 100);
        }// 从12306获取列车数据
        async function fetchTrainData() {
            try {
                // 获取本地时区的今天日期 YYYY-MM-DD
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                
                // 找到当前站最近的特快车停靠站作为查询目标
                const nearestSuperExpressStation = findNearestSuperExpressStation(currentStation);
                
                console.log(`查询从 ${currentStation} 到 ${nearestSuperExpressStation} 的列车信息`);
                  // 尝试从12306获取数据
                try {
                    const trains = await railway12306.queryTrains(currentStation, nearestSuperExpressStation, todayStr);
                    
                    if (trains.length > 0) {                        // 将12306数据转换为我们的格式
                        const convertedTrains = await Promise.all(trains.map(async (train, index) => {
                            try {
                                const details = await railway12306.queryTrainDetails(
                                    train.trainNo, 
                                    railway12306.getStationCode(currentStation),
                                    railway12306.getStationCode(nearestSuperExpressStation),
                                    todayStr
                                );
                                  // 如果queryTrainDetails返回null，说明该列车被过滤掉了（包含佛山西站）
                                if (details === null) {
                                    console.log(`🚫 列车${train.trainCode}被过滤（包含佛山西站），跳过该列车`);
                                    return null;
                                }
                                
                                // 如果details为空数组，说明API调用失败
                                if (!details || details.length === 0) {
                                    console.warn(`⚠️ 列车${train.trainCode}详细信息获取失败，跳过该列车`);
                                    return null;
                                }
                                
                                // 判断列车类型
                                const trainType = railway12306.determineTrainType(train.trainCode, details);
                                  // 从列车详情中获取真正的终点站（最后一个站点）
                                let actualDestination = nearestSuperExpressStation; // 默认值
                                if (details && details.length > 0) {
                                    const lastStation = details[details.length - 1];
                                    if (lastStation && lastStation.station_name) {
                                        // 去除站点名称中的空格，以便正确匹配
                                        let stationName = lastStation.station_name.replace(/\s+/g, '');
                                        // 确保站点名称以"站"结尾
                                        actualDestination = stationName.endsWith('站') ? stationName : stationName + '站';
                                    }
                                }
                                
                                return {
                                    type: trainType,
                                    number: train.trainCode,
                                    time: train.startTime,
                                    destination: actualDestination,
                                    platform: (index % 4 + 1).toString(), // 模拟站台
                                    status: "默认准点", // 这个状态将在renderTrainList中重新计算
                                    note: "1-8号车厢",
                                    trainNo: train.trainNo,
                                    details: details
                                };
                            } catch (error) {
                                console.error('获取列车详细信息失败:', error);
                                return null;
                            }
                        }));                        // 过滤掉null值并更新trainData
                        const validTrains = convertedTrains.filter(train => train !== null);
                        const filteredCount = convertedTrains.length - validTrains.length;
                        
                        console.log(`📊 列车过滤统计:`);
                        console.log(`   原始查询到的列车: ${trains.length}`);
                        console.log(`   转换处理后数量: ${convertedTrains.length}`);
                        console.log(`   被过滤的列车: ${filteredCount} (包含佛山西站或获取失败)`);
                        console.log(`   最终有效列车: ${validTrains.length}`);
                        
                        if (validTrains.length > 0) {
                            trainData = validTrains;
                            console.log('✅ 成功获取12306数据，有效列车数量:', trainData.length);
                            return trainData;
                        } else {
                            console.warn('⚠️ 所有列车都被过滤或无法获取详细信息，将使用模拟数据');
                        }
                    }
                } catch (apiError) {
                    console.warn('12306 API调用失败，使用模拟数据:', apiError.message);
                }
                
                // 如果12306 API失败，生成基于当前时间的模拟数据
                trainData = generateSimulatedTrainData();
                console.log('使用模拟数据，列车数量:', trainData.length);
                return trainData;
                
            } catch (error) {
                console.error('获取列车数据失败:', error);
                return trainData; // 返回现有数据
            }
        }        // 查找最近的特快车停靠站
        function findNearestSuperExpressStation(currentStationName) {
            const currentDirectionStations = getCurrentDirectionStations();
            const currentDirectionSuperExpressStops = getCurrentDirectionSuperExpressStops();
            const currentIndex = currentDirectionStations.indexOf(currentStationName);
            
            if (currentIndex === -1) {
                // 根据方向返回默认终点
                return currentDirection === 'huizhou' ? "肇庆站" : "小金口站";
            }
            
            // 从当前站向前找最近的特快车停靠站
            for (let i = currentIndex + 1; i < currentDirectionStations.length; i++) {
                if (currentDirectionSuperExpressStops.has(currentDirectionStations[i])) {
                    return currentDirectionStations[i];
                }
            }
            
            // 如果向前找不到，返回方向的最后一个特快车站
            return currentDirection === 'huizhou' ? "肇庆站" : "小金口站";
        }        // 生成基于当前时间的模拟列车数据
        function generateSimulatedTrainData() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const currentDirectionStations = getCurrentDirectionStations();
            const currentDirectionExpressStops = getCurrentDirectionExpressStops();
            const currentDirectionSuperExpressStops = getCurrentDirectionSuperExpressStops();
            const currentStationIndex = currentDirectionStations.indexOf(currentStation);
            
            // 为不同列车类型定义可能的终点站
            const getDestinationsForTrainType = (trainType, currentIndex) => {
                if (trainType === '特快') {
                    // 特快列车只到主要特快停靠站
                    return Array.from(currentDirectionSuperExpressStops).filter(station => {
                        const stationIndex = currentDirectionStations.indexOf(station);
                        return stationIndex > currentIndex;
                    });
                } else if (trainType === '快车') {
                    // 快车到快车停靠站
                    return Array.from(currentDirectionExpressStops).filter(station => {
                        const stationIndex = currentDirectionStations.indexOf(station);
                        return stationIndex > currentIndex;
                    });
                } else {
                    // 普通列车可以到所有站点
                    return currentDirectionStations.filter(station => {
                        const stationIndex = currentDirectionStations.indexOf(station);
                        return stationIndex > currentIndex;
                    });
                }
            };
            
            // 生成接下来几小时的列车班次
            const simulatedTrains = [];
            
            for (let i = 0; i < 12; i++) {
                let departMinutes, timeString;
                
                // 为前三个列车设置特定的时间，以确保有不同的状态
                if (i === 0) {
                    // 第一个列车：已发车（比当前时间早5分钟）
                    departMinutes = currentMinutes - 5;
                } else if (i === 1) {
                    // 第二个列车：即将发车（比当前时间晚2分钟）
                    departMinutes = currentMinutes + 2;
                } else if (i === 2) {
                    // 第三个列车：开始检票（比当前时间晚8分钟）
                    departMinutes = currentMinutes + 8;
                } else {
                    // 其他列车：正常间隔
                    departMinutes = currentMinutes + 15 + ((i - 3) * 20);
                }
                
                const hours = Math.floor(departMinutes / 60) % 24;
                const minutes = departMinutes % 60;
                timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                
                const trainTypes = ['普通', '快车', '特快'];
                const trainType = trainTypes[i % 3];
                
                // 获取该列车类型的可能终点站
                const possibleDestinations = getDestinationsForTrainType(trainType, currentStationIndex);
                
                // 根据列车类型选择终点站
                let destination;
                if (possibleDestinations.length === 0) {
                    // 如果没有找到合适的终点站，使用默认的最后一站
                    destination = currentDirection === 'huizhou' ? "肇庆站" : "小金口站";
                } else if (trainType === '特快') {
                    // 特快列车倾向于选择更远的站点
                    const farStations = possibleDestinations.slice(-3); // 最后3个站点
                    destination = farStations[i % farStations.length];
                } else if (trainType === '快车') {
                    // 快车选择中等距离的站点
                    const midIndex = Math.floor(possibleDestinations.length / 2);
                    const midStations = possibleDestinations.slice(Math.max(0, midIndex - 2), midIndex + 3);
                    destination = midStations[i % midStations.length];
                } else {
                    // 普通列车随机选择各种距离的站点
                    destination = possibleDestinations[i % possibleDestinations.length];
                }
                
                // 根据列车类型和方向生成车次号
                let trainNumber;
                if (trainType === '特快') {
                    // 特快: 6880-6899
                    trainNumber = `C${6880 + (i % 20)}`;
                } else if (trainType === '快车') {
                    // 快车: 其余68开头（6800-6870，避免接近特快范围）
                    trainNumber = `C${6800 + (i % 71)}`;
                } else {
                    // 普通: 非68开头，根据方向使用不同的车次范围
                    const baseNumber = currentDirection === 'huizhou' ? 7600 : 7500;
                    trainNumber = `C${baseNumber + i}`;
                }
                
                simulatedTrains.push({
                    type: trainType,
                    number: trainNumber,
                    time: timeString,
                    destination: destination,
                    platform: ((i % 4) + 1).toString(),
                    status: "准点", // 这个状态将在渲染时重新计算
                    note: "1-8号车厢"
                });
            }
            
            return simulatedTrains;
        }

        // 站点输入框功能
        function initStationInput() {
            const stationInput = document.getElementById('currentStationInput');
            const suggestions = document.getElementById('stationSuggestions');
            
            // 输入框焦点和失焦事件
            stationInput.addEventListener('focus', function() {
                showSuggestions(stationInput.value);
            });
            
            // 输入事件
            stationInput.addEventListener('input', function() {
                const value = this.value.trim();
                showSuggestions(value);
            });
            
            // 失焦事件（延迟执行以允许点击建议项）
            stationInput.addEventListener('blur', function() {
                setTimeout(() => {
                    suggestions.style.display = 'none';
                }, 200);
            });
              // 回车确认
            stationInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const value = this.value.trim();
                    const currentDirectionStations = getCurrentDirectionStations();
                    if (currentDirectionStations.includes(value) || currentDirectionStations.includes(value + '站')) {
                        updateCurrentStation(value.endsWith('站') ? value : value + '站');
                        suggestions.style.display = 'none';
                        this.blur();
                    }
                }
            });
        }
          function showSuggestions(query) {
            const suggestions = document.getElementById('stationSuggestions');
            const currentDirectionStations = getCurrentDirectionStations();
            
            if (!query) {
                // 显示当前方向的所有站点
                const html = currentDirectionStations.map(station => 
                    `<div class="station-suggestion-item" onclick="selectStation('${station}')">${station}</div>`
                ).join('');
                suggestions.innerHTML = html;
                suggestions.style.display = 'block';
                return;
            }
            
            // 过滤匹配的站点
            const filteredStations = currentDirectionStations.filter(station => 
                station.includes(query) || station.replace('站', '').includes(query)
            );
            
            if (filteredStations.length > 0) {
                const html = filteredStations.map(station => 
                    `<div class="station-suggestion-item" onclick="selectStation('${station}')">${station}</div>`
                ).join('');
                suggestions.innerHTML = html;
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }
        
        function selectStation(station) {
            updateCurrentStation(station);
            document.getElementById('stationSuggestions').style.display = 'none';
        }
          function updateCurrentStation(station) {
            currentStation = station;
            document.getElementById('currentStationInput').value = station;
            // 重新渲染列车列表以更新站点状态
            renderTrainList();
        }

        // 刷新12306数据
        async function refreshTrainData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            const dataSource = document.getElementById('dataSource');
            
            // 更新按钮状态
            refreshBtn.disabled = true;
            refreshBtn.textContent = '获取中...';
            dataSource.textContent = '数据源: 获取中...';
            
            try {
                await fetchTrainData();
                renderTrainList();
                dataSource.textContent = '数据源: 12306 API';
            } catch (error) {
                console.error('刷新数据失败:', error);
                dataSource.textContent = '数据源: 模拟数据 (API失败)';
            } finally {
                // 恢复按钮状态
                refreshBtn.disabled = false;
                refreshBtn.textContent = '刷新12306数据';
            }
        }        // 初始化和定时更新
        async function init() {
            updateCurrentTime();
            initStationInput();
            
            // 初始化12306 API并获取数据
            console.log('正在初始化12306 API...');
            try {
                await fetchTrainData();
                document.getElementById('dataSource').textContent = '数据源: 12306 API';
            } catch (error) {
                console.error('初始化12306数据失败:', error);
                document.getElementById('dataSource').textContent = '数据源: 模拟数据';
            }
            
            renderTrainList();
            
            setInterval(updateCurrentTime, 1000);
            
            // 移除自动刷新功能，现在只能通过手动点击"刷新12306数据"按钮来刷新
            console.log('自动刷新已关闭，请手动点击"刷新12306数据"按钮来更新数据');
        }

        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            scrollManager.clearAllScrolling();
        });

        document.addEventListener('DOMContentLoaded', init);        // 交互效果
        document.addEventListener('click', function(e) {
            if (e.target.closest('.train-item')) {
                const trainItem = e.target.closest('.train-item');
                trainItem.style.transform = 'scale(1.01)';
                setTimeout(() => {
                    trainItem.style.transform = '';
                }, 200);
            }
        });        // 将函数设置为全局，以便HTML onclick可以调用
        window.selectStation = selectStation;
        window.refreshTrainData = refreshTrainData;
        window.switchDirection = switchDirection;
    </script>
</body>
</html>